generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String         @id @default(cuid())
  username        String         @unique
  email           String         @unique
  walletAddress   String?        @unique
  password        String?
  userType        UserType       @default(FREELANCER)
  isVerified      Boolean        @default(false)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  applications    Application[]  @relation("FreelancerApplications")
  drafts          JobDraft[]
  postedJobs      Job[]          @relation("ClientJobs")
  profile         Profile?
  refreshTokens   RefreshToken[]
  sentReviews     Review[]       @relation("ReviewSender")
  receivedReviews Review[]       @relation("ReviewReceiver")

  @@map("users")
}

model Profile {
  id            String   @id @default(cuid())
  userId        String   @unique
  firstName     String?
  lastName      String?
  bio           String?
  title         String?
  location      String?
  website       String?
  companyName   String?
  avatar        String?
  skills        String[]
  hourlyRate    Float?
  portfolio     String[]
  experience    Int?
  rating        Float?   @default(0)
  completedJobs Int?     @default(0)
  totalEarnings Float?   @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([hourlyRate])
  @@index([experience])
  @@index([rating])
  @@map("profiles")
}

model Job {
  id                       String        @id @default(cuid())
  title                    String
  description              String
  clientId                 String
  budgetAmount             Float
  budgetType               BudgetType
  currency                 String        @default("USD")
  duration                 String
  deadline                 DateTime?
  skills                   String[]
  requirements             String[]
  status                   JobStatus     @default(OPEN)
  createdAt                DateTime      @default(now())
  updatedAt                DateTime      @updatedAt
  escrowDeployed           Boolean       @default(false)
  escrowDeploymentAttempts Int           @default(0)
  escrowOnChainId          Int?
  escrowPending            Boolean       @default(false)
  useBlockchain            Boolean       @default(false)
  escrowRollbackRequested  Boolean       @default(false)
  escrowRollbackReason     String?
  escrowCancelledAt        DateTime?
  applications             Application[]
  client                   User          @relation("ClientJobs", fields: [clientId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([clientId])
  @@index([createdAt])
  @@index([status, createdAt])
  @@index([escrowPending])
  @@index([escrowDeployed])
  @@index([escrowRollbackRequested])
  @@map("jobs")
}

model Application {
  id                String            @id @default(cuid())
  jobId             String
  freelancerId      String
  coverLetter       String
  proposedRate      Float
  estimatedDuration String
  portfolio         String?
  status            ApplicationStatus @default(PENDING)
  appliedAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  freelancer        User              @relation("FreelancerApplications", fields: [freelancerId], references: [id], onDelete: Cascade)
  job               Job               @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([jobId, freelancerId])
  @@map("applications")
}

model JobDraft {
  id        String   @id @default(cuid())
  clientId  String
  data      Json
  published Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  client    User     @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId, updatedAt])
  @@map("job_drafts")
}

model Review {
  id         String   @id @default(cuid())
  fromUserId String
  toUserId   String
  rating     Int
  comment    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  fromUser   User     @relation("ReviewSender", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser     User     @relation("ReviewReceiver", fields: [toUserId], references: [id], onDelete: Cascade)

  @@unique([fromUserId, toUserId])
  @@map("reviews")
}

model RefreshToken {
  tokenHash    String    @id
  userId       String
  userAgent    String?
  ip           String?
  expiresAt    DateTime
  revokedAt    DateTime?
  replacedById String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

enum UserType {
  FREELANCER
  CLIENT
  BOTH
}

enum BudgetType {
  FIXED
  HOURLY
}

enum JobStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ApplicationStatus {
  PENDING
  ACCEPTED
  REJECTED
}
